export class jFSMRouter{static Create(t){return new jFSMRouter(t)}constructor(t){this.t=new RegExp(/\/(:\w+)\[(?:09|AZ)]\/(?:.+\/)?(\1)(?:\[(?:09|AZ)]|\/|$)/g),this.i=new RegExp(/(?<=^|\/):(\w+)(?:\[(09|AZ)])?(?=\/|$)/g),this.h=[],this.o=void 0,this.l=void 0,this.u=!1,this.v=[],this.A=!1,this.p={},this.S={},window.addEventListener("hashchange",this.CheckHash.bind(this)),this.StateAdd(t),this.O=t}StateAdd(t){let i=!1;return void 0===this.p[t]&&(this.p[t]={OnEnter:[],OnLeave:[]},this.S[t]={},i=!0),i}StateDel(t){let i=!1;if(void 0!==this.p[t]){delete this.p[t],void 0!==this.S[t]&&delete this.S[t];for(const i in this.S)void 0!==this.S[i][t]&&delete this.S[i][t];i=!0}return i}StateOnEnterAdd(t,i){let s=!1;return void 0!==this.p[t]&&(this.p[t].OnEnter.includes(i)||(this.p[t].OnEnter.push(i),s=!0)),s}StateOnEnterDel(t,i){let s=!1;if(void 0!==this.p[t]){const h=this.p[t].OnEnter.indexOf(i);-1!==h&&(this.p[t].OnEnter.splice(h,1),s=!0)}return s}StateOnLeaveAdd(t,i){let s=!1;return void 0!==this.p[t]&&(this.p[t].OnLeave.includes(i)||(this.p[t].OnLeave.push(i),s=!0)),s}StateOnLeaveDel(t,i){let s=!1;if(void 0!==this.p[t]){const h=this.p[t].OnLeave.indexOf(i);-1!==h&&(this.p[t].OnLeave.splice(h,1),s=!0)}return s}TransitionAdd(t,i){let s=!1;return void 0!==this.p[t]&&void 0!==this.p[i]&&void 0===this.S[t][i]&&(this.S[t][i]={OnBefore:[],OnAfter:[]},s=!0),s}TransitionDel(t,i){let s=!1;return void 0!==this.p[t]&&void 0!==this.p[i]&&void 0!==this.S[t][i]&&(delete this.S[t][i],s=!0),s}TransitionOnBeforeAdd(t,i,s){let h=!1;return void 0!==this.p[t]&&void 0!==this.p[i]&&void 0!==this.S[t][i]&&(this.S[t][i].OnBefore.push(s),h=!0),h}TransitionOnBeforeDel(t,i,s){let h=!1;if(void 0!==this.p[t]&&void 0!==this.p[i]&&void 0!==this.S[t][i]){const e=this.S[t][i].OnBefore.indexOf(s);-1!==e&&(this.S[t][i].OnBefore.splice(e,1),h=!0)}return h}TransitionOnAfterAdd(t,i,s){let h=!1;return void 0!==this.p[t]&&void 0!==this.p[i]&&void 0!==this.S[t][i]&&(this.S[t][i].OnAfter.push(s),h=!0),h}TransitionOnAfterDel(t,i,s){let h=!1;if(void 0!==this.p[t]&&void 0!==this.p[i]&&void 0!==this.S[t][i]){const e=this.S[t][i].OnAfter.indexOf(s);-1!==e&&(this.S[t][i].OnAfter.splice(e,1),h=!0)}return h}StateGet(){return this.O}async StateSet(t){let i=!1;if(!this.A){if(void 0!==this.p[t]&&void 0!==this.S[this.O]&&void 0!==this.S[this.O][t]){let s;i=!0,s=this.S[this.O][t].OnBefore.length;for(let h=0;i&&h<s;h++)if("function"==typeof this.S[this.O][t].OnBefore[h]){let s=null;s="AsyncFunction"===this.S[this.O][t].OnBefore[h].constructor.name?await this.S[this.O][t].OnBefore[h]():this.S[this.O][t].OnBefore[h](),i=!1!==s}if(i){s=this.p[this.O].OnLeave.length;for(let i=0;i<s;i++)"function"==typeof this.p[this.O].OnLeave[i]&&("AsyncFunction"===this.p[this.O].OnLeave[i].constructor.name?await this.p[this.O].OnLeave[i](this.O,t):this.p[this.O].OnLeave[i](this.O,t));let i=this.O;this.O=t,s=this.S[i][this.O].OnAfter.length;for(let t=0;t<s;t++)"function"==typeof this.S[i][this.O].OnAfter[t]&&("AsyncFunction"===this.S[i][this.O].OnAfter[t].constructor.name?await this.S[i][this.O].OnAfter[t]():this.S[i][this.O].OnAfter[t]());s=this.p[this.O].OnEnter.length;for(let t=0;t<s;t++)"function"==typeof this.p[this.O].OnEnter[t]&&("AsyncFunction"===this.p[this.O].OnEnter[t].constructor.name?await this.p[this.O].OnEnter[t](this.O,i):this.p[this.O].OnEnter[t](this.O,i))}}this.A=!1}return i}CheckTransition(t){let i=!1;return this.A||void 0!==this.p[t]&&void 0!==this.S[this.O]&&void 0!==this.S[this.O][t]&&(i=!0),i}RouteSpecialAdd(t,i){let s=!1;switch(t){case 403:this.o=i,s=!0;break;case 404:this.l=i,s=!0;break;default:throw new RangeError}return s}RouteAdd(t,i,s,h,e){let n=!1;if(void 0===this.p[t])throw new SyntaxError("Non-existent state");if(i.match(this.t))throw new SyntaxError("Duplicate path id");{let o=0;const r=i.split("/"),a=r.length;for(let t=0;t<a;t++)r[t].startsWith(":")||(o+=2^a-t-1);let d=new RegExp("^"+i.replace(this.i,(function(t,i,s){let h="(?<"+i+">[";switch(s){case"09":h+="\\d";break;case"AZ":h+="a-zA-Z";break;default:h+="\\w"}return h+="]+)",h})).replace(/\//g,"\\/")+"$");const l=i.replace(this.i,":$2");this.h.find((t=>l===t.path))||(this.h.push({path:l,validState:t,match:d,weight:o,routeFunction:s,available:h,routeFunction403:e}),this.h.sort(((t,i)=>t.weight>i.weight?-1:i.weight>t.weight?1:0)),n=!0)}return n}RouteDel(t){let i=!1;if(!t.match(this.t))throw new SyntaxError("Duplicate path id");{const s=t.replace(this.i,":$2"),h=this.h.findIndex((t=>s==t.path));-1<h&&(this.h.splice(h,1),i=!0)}return i}Trigger(t){"#"+t!=window.location.hash&&(window.location.hash="#"+t)}async Route(t){let i;this.u=!0;let s="",h=null;for(const e of this.h)if(h=e.match.exec(t)){s=e.path;let n=!0;e.available&&(n=!1,"function"==typeof e.available&&(n="AsyncFunction"===e.available.constructor.name?await e.available(s,t,h.groups??{}):e.available(s,t,h.groups??{}))),n&&(void 0===e.validState||this.O===e.validState||this.CheckTransition(e.validState))?(e.validState&&this.O!==e.validState&&await this.StateSet(e.validState),i=e.routeFunction):e.routeFunction403?i=e.routeFunction403:this.o&&(i=this.o);break}i&&"function"==typeof i||this.l&&(i=this.l),i&&"function"==typeof i&&("AsyncFunction"===i.constructor.name?await i(s,t,h?.groups??{}):i(s,t,h?.groups??{})),this.v.length?await this.Route(this.v.shift()):this.u=!1}async CheckHash(){let t=window.location.hash.startsWith("#")?window.location.hash.substring(1):"";""!=t&&(this.u?this.v.push(t):await this.Route(t))}}